name: doc_refinement
on:
  workflow_dispatch:
    inputs:
      doc_iteration:
        description: Current iteration phase for cycle improve_docs
        required: false
        default: "0"
      run_id:
        description: Run ID for artifact retrieval
        required: false
        default: ""
concurrency:
  group: ${{ inputs._cycle_key || 'doc_iteration' }}
  cancel-in-progress: false
jobs:
  initialize:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - run: echo Initializing documentation review process
  finalize:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - run: echo Documentation refinement complete
  improve_docs_hydrate:
    runs-on: ubuntu-latest
    outputs:
      phase: ${{ steps.init_state.outputs.phase }}
    steps:
      - name: Download cycle state
        uses: actions/download-artifact@v4
        if: github.event.inputs.doc_iteration != '0' && github.event.inputs.doc_iteration != ''
        with:
          name: improve_docs-state
          path: .cycle-state
          run-id: ${{ github.event.inputs.run_id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
      - name: Initialize cycle state
        id: init_state
        run: |-
          PHASE=${{ github.event.inputs.doc_iteration || '0' }}
          if [ -f .cycle-state/state.json ]; then
            echo "Loaded state from artifact"
            cat .cycle-state/state.json
          else
            echo '{"doc_iteration": '$PHASE'}' > state.json
            mkdir -p .cycle-state
            cp state.json .cycle-state/state.json
          fi
          echo "phase=$PHASE" >> $GITHUB_OUTPUT
        shell: bash
  improve_docs_body_review_docs:
    runs-on: ubuntu-latest
    needs:
      - improve_docs_hydrate
    steps:
      - uses: actions/checkout@v4
      - name: review_docs-task
        uses: anthropics/claude-code-action@v1
        with:
          prompt: Review documentation for clarity and completeness
          allowed_tools: '["Read","Glob","Grep","Write"]'
          max_turns: 8
          model: claude-sonnet-4-20250514
      - name: Upload doc_review
        uses: actions/upload-artifact@v4
        with:
          name: doc_review
          path: doc_review
  improve_docs_body_apply_suggestions:
    runs-on: ubuntu-latest
    needs:
      - improve_docs_hydrate
      - improve_docs_body_review_docs
    steps:
      - uses: actions/checkout@v4
      - run: echo Applying documentation improvements
      - run: git diff --stat || true
  improve_docs_decide:
    runs-on: ubuntu-latest
    needs:
      - improve_docs_body_apply_suggestions
    outputs:
      continue: ${{ steps.eval_guard.outputs.continue }}
      termination_reason: ${{ steps.eval_guard.outputs.termination_reason }}
    steps:
      - name: Evaluate guard condition
        id: eval_guard
        run: |-
          node -e "const fs = require('fs'); let state = {}; if (fs.existsSync('.cycle-state/state.json')) {   state = JSON.parse(fs.readFileSync('.cycle-state/state.json', 'utf8')); } const phase = parseInt(process.env.PHASE || '0', 10); const maxIters = 3; const context = { ...state, doc_iteration: phase }; const guardResult = (function() {        return context.approval_count >= 2;      })(); console.log('Guard result:', guardResult); let terminationReason = 'continue'; let shouldContinue = true; if (guardResult) {   terminationReason = 'guard_satisfied';   shouldContinue = false; } else if (maxIters !== null && phase >= maxIters - 1) {   terminationReason = 'max_iterations';   shouldContinue = false; } console.log('Termination reason:', terminationReason); fs.writeFileSync('.cycle-state/continue.txt', shouldContinue ? 'true' : 'false'); fs.writeFileSync('.cycle-state/termination_reason.txt', terminationReason); fs.writeFileSync('.cycle-state/state.json', JSON.stringify({ ...context, quality_score: context.quality_score || 0 }));"
          CONTINUE=$(cat .cycle-state/continue.txt)
          TERMINATION_REASON=$(cat .cycle-state/termination_reason.txt)
          echo "continue=$CONTINUE" >> $GITHUB_OUTPUT
          echo "termination_reason=$TERMINATION_REASON" >> $GITHUB_OUTPUT
        shell: bash
        env:
          PHASE: ${{ needs.improve_docs_hydrate.outputs.phase }}
      - name: Upload cycle state
        uses: actions/upload-artifact@v4
        with:
          name: improve_docs-state
          path: .cycle-state
  improve_docs_dispatch:
    runs-on: ubuntu-latest
    needs:
      - improve_docs_decide
      - improve_docs_hydrate
    if: needs.improve_docs_decide.outputs.continue == 'true' && ${{ needs.improve_docs_hydrate.outputs.phase }} < 3
    steps:
      - name: Dispatch next iteration
        run: |-
          NEXT_PHASE=$(( ${{ needs.improve_docs_hydrate.outputs.phase }} + 1 ))
          gh workflow run "${{ github.workflow }}" \
            --ref "${{ github.ref }}" \
            -f doc_iteration=$NEXT_PHASE \
            -f run_id=${{ github.run_id }}
          echo "Dispatched iteration $NEXT_PHASE"
        shell: bash
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

